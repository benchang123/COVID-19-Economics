---
title: "Part1"
author: "Nicolas Min"
date: "2/16/2021"
output: pdf_document
---
```{r include=FALSE}
#=============
#packages used
#=============

library(dplyr)
library(ggplot2)
library(lubridate)
library(stringr)
library(knitr)
```


```{r echo=FALSE}
#============================
#import/clean/manipulate data
#===========================-
setwd("~/Desktop/!STAT MA 2020/!222/1. EDA")
#import data
ssa <- read.csv("SSA-SA-MOWL.csv", header = FALSE) %>%
  
  #rename the columns
  rename(
    filename = "V1",
    fileversion = "V2",
    updatedate = "V3",
    regioncode = "V4",
    statecode = "V5",
    datetype = "V6",
    date = "V7",
    formatteddate = "V8",
    initial_total = "V9",
    initial_ssdi_only = "V14",
    initial_ssi_only = "V19",
    initial_concurrent = "V24",
    reconsideration_total = "V35",
    reconsideration_ssdi_only = "V40",
    reconsideration_ssi_only = "V45",
    reconsideration_concurrent = "V50",
    cdr_total = "V60",
    cdr_ssdi_only = "V65",
    cdr_ssi_only = "V70",
    cdr_concurrent = "V75"
  ) %>%
  
  #compute for ALL SSDI and ALL SSI.
  mutate(initial_ssdi_total = initial_total - initial_ssi_only) %>%
  mutate(initial_ssi_total = initial_total - initial_ssdi_only) %>%
  mutate(reconsideration_ssdi_total = reconsideration_total - reconsideration_ssi_only) %>%
  mutate(reconsideration_ssi_total = reconsideration_total - reconsideration_ssdi_only) %>%
  
  #combine initial and reconsideration
  mutate(all_total = initial_total + reconsideration_total) %>%
  mutate(all_ssdi_total = initial_ssdi_total + reconsideration_ssdi_total) %>%
  mutate(all_ssi_total = initial_ssi_total + reconsideration_ssi_total)

```

```{r echo=FALSE}
#==============
#recreate table
#==============

#unique dates (given)
date <- unique(ssa$date)

#MO (given)
MO <- unique(ssa$formatteddate)

#QR
QR <- str_replace(MO, "-01|-02", "-03")
QR <- str_replace(QR, "-04|-05", "-06")
QR <- str_replace(QR, "-07|-08", "-09")
QR <- str_replace(QR, "-10|-11", "-12")

#FY
FY <- rep(2001:2021, each = 12)
FY <- as.character(FY[1:243])

#calendar year
CY <- c(rep(2000, 3), rep(2001:2020, each = 12))
CY <- as.character(CY)

#compute for weeks included
#change in to a date format that R likes
real_dates <- mdy(date)
days <- day(real_dates)
#compute the number of weeks
#if the end date is later than the 28th, there are 5 weeks included in the month
#otherwise, 4 weeks included
weeks_included <- ifelse(days - 28 > 0, 5, 4)

#combine above & create a data frame
translation_table <-
  data.frame(date, MO, QR, FY, QR, CY, weeks_included)

#addressing exceptions (mentioned in the ssa website)
#1. The final week of 2004 and 2010 are included in Jan of 2005 and 2011
translation_table$weeks_included[translation_table$MO == "2005-01"] <- 5
translation_table$weeks_included[translation_table$MO == "2011-01"] <- 5
#2. Week 53 should not be counted anywhere
translation_table$weeks_included[translation_table$MO == "2005-12"] <- 4
translation_table$weeks_included[translation_table$MO == "2011-12"] <- 4

```

```{r echo=FALSE}
#========================================================
#include "weeks_included" information in our raw ssa data
#========================================================

#create a sub table
weeks_included_table <-
  translation_table %>% select(date, weeks_included)

#join the above sub table with our data
ssa <- ssa %>% full_join(weeks_included_table, by = "date")

#clean date for plotting
ssa$date <- mdy(ssa$date)
ssa$month_numeric <- as.integer(str_sub(ssa$formatteddate, -2))
```


```{r echo=FALSE}
#====================
#manipulate ssa data
#===================

#first, group by date and manipulate data
ssa_all_unadjusted <-
  ssa %>% group_by(date) %>%
  mutate(us_all_total = sum(all_total)) %>%
  mutate(us_all_ssdi_total = sum(all_ssdi_total)) %>%
  mutate(us_all_ssi_total = sum(all_ssi_total)) %>%
  mutate(us_initial_total = sum(initial_total)) %>%
  mutate(us_reconsideration_total = sum(reconsideration_total)) %>%
  mutate(us_cdr_total = sum(cdr_total)) %>%
  select(
    date,
    month_numeric,
    us_all_total,
    us_all_ssdi_total,
    us_all_ssi_total,
    us_initial_total,
    us_reconsideration_total,
    us_cdr_total,
    weeks_included
  ) %>%
  slice(1) %>% #only take one entry per date
  ungroup()

#now, normalize the number of apps by taking weekly averages
ssa_all_adjusted <-
  ssa_all_unadjusted %>%
  mutate(us_all_total_weeklyavg = us_all_total / weeks_included) %>%
  mutate(us_all_ssdi_total_weeklyavg = us_all_ssdi_total / weeks_included) %>%
  mutate(us_all_ssi_total_weeklyavg = us_all_ssi_total / weeks_included) %>%
  mutate(us_initial_total_weeklyavg = us_initial_total / weeks_included) %>%
  mutate(us_reconsideration_total_weeklyavg = us_reconsideration_total /
           weeks_included) %>%
  mutate(us_cdr_total_weeklyavg = us_cdr_total / weeks_included)
```

```{r echo=FALSE}
#===========================
#average for years 2000-2019
#===========================

#filter for dates before 2020-01-01
ssa_pre_2020 <- ssa_all_adjusted %>% 
  filter(date > "2000-01-01" & date < "2020-01-01")

#manipulate the data before 2020-01-01
ssa_pre_2020 <- ssa_pre_2020 %>% group_by(month_numeric) %>%
  
  #compute avgs based on month (for unadjusted measures)
  mutate(pre2020avg_us_all_total = mean(us_all_total)) %>%
  mutate(pre2020avg_us_all_ssdi_total = mean(us_all_ssdi_total)) %>%
  mutate(pre2020avg_us_all_ssi_total = mean(us_all_ssi_total)) %>%
  mutate(pre2020avg_us_initial_total = mean(us_initial_total)) %>%
  mutate(pre2020avg_us_reconsideration_total = mean(us_reconsideration_total)) %>%
  mutate(pre2020avg_us_cdr_total = mean(us_cdr_total)) %>%
  
  #compute avgs based on month (for adjusted measures)
  mutate(pre2020avg_us_all_total_weeklyavg = mean(us_all_total_weeklyavg)) %>%
  mutate(pre2020avg_us_all_ssdi_total_weeklyavg = mean(us_all_ssdi_total_weeklyavg)) %>%
  mutate(pre2020avg_us_all_ssi_total_weeklyavg = mean(us_all_ssi_total_weeklyavg)) %>%
  mutate(pre2020avg_us_initial_total_weeklyavg = mean(us_initial_total_weeklyavg)) %>%
  mutate(
    pre2020avg_us_reconsideration_total_weeklyavg = mean(us_reconsideration_total_weeklyavg)
  ) %>%
  mutate(pre2020avg_us_cdr_total_weeklyavg = mean(us_cdr_total_weeklyavg)) %>%
  
  slice(1) %>% #only take one entry per date
  ungroup() %>%
  
  #select only the avgs over the years, 2000-2019
  select(
    date,
    month_numeric,
    pre2020avg_us_all_total,
    pre2020avg_us_all_ssdi_total,
    pre2020avg_us_all_ssi_total,
    pre2020avg_us_initial_total,
    pre2020avg_us_reconsideration_total,
    pre2020avg_us_cdr_total,
    pre2020avg_us_all_total_weeklyavg,
    pre2020avg_us_all_ssdi_total_weeklyavg,
    pre2020avg_us_all_ssi_total_weeklyavg,
    pre2020avg_us_initial_total_weeklyavg,
    pre2020avg_us_reconsideration_total_weeklyavg,
    pre2020avg_us_cdr_total_weeklyavg
  )

#filter for dates after 2020-01-01
ssa_2020 <- ssa_all_adjusted %>% filter(date > "2020-01-01")
###ssa_2020$date <- month(ssa_2020$date)

#join the pre and post 2020-01-01 tables
ssa_complete <- ssa_pre_2020 %>%
  full_join(ssa_2020, by = "month_numeric") %>%
  ungroup()
```

\newpage

```{r echo=FALSE}
#====================================
#plot (cdr)
#====================================
#plot(adj_cdr)
ssa_complete %>%
  ggplot(aes(x = month_numeric)) +
  geom_line(aes(y = pre2020avg_us_cdr_total_weeklyavg, color = "Pre-2020 avg")) +
  geom_line(aes(y = us_cdr_total_weeklyavg, color = "2020")) +
  geom_point(aes(y = pre2020avg_us_cdr_total_weeklyavg, color = "Pre-2020 avg")) +
  geom_point(aes(y = us_cdr_total_weeklyavg, color = "2020")) +
  scale_x_continuous(breaks = seq(0, 12, 1)) +
  ylab("Weekly Avg Applications") +
  xlab("Month") +
  ggtitle("All CDR Applications Processing by Month\
          - Weeks adjusted") +
  theme_bw() +
  theme(legend.position = "bottom") +
  theme(legend.title = element_blank()) 
```

Government has generally been slow in the aftermath of the pandemic. For instance, SSA has been facing difficulties in processing claims and transferring them to the state agencies. This is evidenced by the steep decline shown in the Graph in which the CDR has nothing to do with the actual submission of the disability application but only has to do with the SSA requesting the state agencies to conduct a medical review.
 